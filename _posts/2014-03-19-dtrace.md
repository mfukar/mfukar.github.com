---
layout: post
title: Useful DTrace recipes
tags: dtrace profile
year: 2014
month: 03
day: 27
published: false
summary: Useful recipes to use with DTrace.
---

# Intro
If there ever was one tool I wanted to see in Linux, it is DTrace. Ever since its release
by Sun Microsystems, it has been an incredibly useful tool to trace, measure, and
troubleshoot kernel and application issues. Since I've been mostly working on an OS X
environment for the past ~9 months, I've had the pleasure of using it again for various
(un-)common tasks.

I've decided to band them all together and keep them in one place, to serve as a reference
for me, and hopefully be useful to others as well:

# Recipes

    # New processes with arguments:
    dtrace -n 'proc:::exec-success { trace(curpsinfo->pr_psargs); }'

    # Files opened by process:
    dtrace -n 'syscall::open*:entry { printf("%s %s",execname,copyinstr(arg0)); }'

    # Syscall count by program:
    dtrace -n 'syscall:::entry { @num[execname] = count(); }'

    # Syscall count by syscall:
    dtrace -n 'syscall:::entry { @num[probefunc] = count(); }'

    # Syscall count by PID:
    dtrace -n 'syscall:::entry { @num[pid,execname] = count(); }'

    # Read bytes by process:
    dtrace -n 'sysinfo:::readch { @bytes[execname] = sum(arg0); }'

    # Written bytes by process:
    dtrace -n 'sysinfo:::writech { @bytes[execname] = sum(arg0); }'

    # Read size distribution by process:
    dtrace -n 'sysinfo:::readch { @dist[execname] = quantize(arg0); }'

    # Write size distribution by process:
    dtrace -n 'sysinfo:::writech { @dist[execname] = quantize(arg0); }'

    # Disk size (in blocks) by process:
    dtrace -n 'io:::start { printf("%d %s %d",pid,execname,args[0]->b_bcount); }'

    # Pages paged in by process:
    dtrace -n 'vminfo:::pgpgin { @pg[execname] = sum(arg0); }'

    # Minor faults by process:
    dtrace -n 'vminfo:::as_fault { @mem[execname] = sum(arg0); }'

    # Interrupts by CPU:
    dtrace -n 'sdt:::interrupt-start { @num[cpu] = count(); }'

    # New processes with arguments and time:
    dtrace -qn 'syscall::exec*:return { printf("%Y %s\n",walltimestamp,curpsinfo->pr_psargs); }'

    # Successful signal details:
    dtrace -n 'proc:::signal-send /pid/ { printf("%s -%d %d",execname,args[2],args[1]->pr_pid); }'

    # System call breakdown for the process with PID 31337:
    dtrace -n syscall:::entry'/pid == 31337/{ @syscalls[probefunc] = count(); }'

    # Tracking memory page faults for process:
    dtrace -n 'vminfo:::as_fault { @mem[execname] = sum(arg0); }'

    # iOS Intruments-like malloc size distribution plot:
    dtrace -n 'pid$target::malloc:entry { @ = quantize(arg0); }' -p PID

    # Memory allocation via malloc by stack trace and requested size:
    dtrace -n 'pid$target::malloc:entry { @[ustack()] = sum(arg0); }' -p PID

    # Rate of disk I/O:
    dtrace -n 'io:::start { @io = count(); } tick-1sec { printa("Disk I/Os per second: %@d\n", @io); trunc(@io); }'


# Examples

## Files opened by process:

    # dtrace -n 'syscall::open*:entry { printf("%s %s",execname,copyinstr(arg0)); }'
    dtrace: description 'syscall::open*:entry ' matched 2 probes
    CPU     ID                    FUNCTION:NAME
      0     14                       open:entry gnome-netstatus- /dev/kstat
      0     14                       open:entry man /var/ld/ld.config
      0     14                       open:entry man /lib/libc.so.1
      0     14                       open:entry man /usr/share/man/man.cf
      0     14                       open:entry man /usr/share/man/windex
      0     14                       open:entry man /usr/share/man/man1/ls.1
      0     14                       open:entry man /usr/share/man/man1/ls.1
      0     14                       open:entry man /tmp/mpqea4RF
      0     14                       open:entry sh /var/ld/ld.config
      0     14                       open:entry sh /lib/libc.so.1
      0     14                       open:entry neqn /var/ld/ld.config
      0     14                       open:entry neqn /lib/libc.so.1
      0     14                       open:entry neqn /usr/share/lib/pub/eqnchar
      0     14                       open:entry tbl /var/ld/ld.config
      0     14                       open:entry tbl /lib/libc.so.1
      0     14                       open:entry tbl /usr/share/man/man1/ls.1
      0     14                       open:entry nroff /var/ld/ld.config
    [...]


## Written bytes by process:

    # dtrace -n 'sysinfo:::writech { @bytes[execname] = sum(arg0); }'
    dtrace: description 'sysinfo:::writech ' matched 4 probes
    ^C

      dtrace                                                            1
      gnome-settings-d                                                  8
      xscreensaver                                                      8
      gnome-panel                                                       8
      nautilus                                                          8
      date                                                             29
      wnck-applet                                                     120
      bash                                                            210
      mozilla-bin                                                    1497
      ls                                                             1947
      metacity                                                       3172
      Xorg                                                           7424
      gnome-terminal                                                51955


## Write size distribution by process:

    # dtrace -n 'sysinfo:::writech { @dist[execname] = quantize(arg0); }'
    dtrace: description 'sysinfo:::writech ' matched 4 probes
    ^C
    [...]
      Xorg
               value  ------------- Distribution ------------- count
                  16 |                                         0
                  32 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       169
                  64 |@@@                                      16
                 128 |@@                                       10
                 256 |                                         0


## Interrupts by CPU:

    # dtrace -n 'sdt:::interrupt-start { @num[cpu] = count(); }'
    dtrace: description 'sdt:::interrupt-start ' matched 1 probe
    ^C

          513                2
          515                4
            3               39
            2               39

## Rate of disk I/O:

    # sudo dtrace -n 'io:::start { @io = count(); } tick-1sec { printa("Disk I/Os per second: %@d", @io); trunc(@io); }' -p 428
    dtrace: description 'io:::start ' matched 2 probes
    CPU     ID                    FUNCTION:NAME
      6 183582                       :tick-1sec
      6 183582                       :tick-1sec
      6 183582                       :tick-1sec Disk I/Os per second: 5
      6 183582                       :tick-1sec Disk I/Os per second: 2
      6 183582                       :tick-1sec
